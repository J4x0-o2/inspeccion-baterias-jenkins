# ============================================
# CI: ValidaciÃ³n de CÃ³digo
# Se ejecuta en: push a develop y PRs a master
# ============================================

name: ğŸ” Validar CÃ³digo

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - master
      - main

jobs:
  validate:
    name: Validar HTML, JSON y estructura
    runs-on: ubuntu-latest
    
    steps:
      # Descargar cÃ³digo del repositorio
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # Validar que index.html existe
      - name: âœ… Verificar index.html
        run: |
          if [ ! -f "index.html" ]; then
            echo "âŒ ERROR: index.html no encontrado"
            exit 1
          fi
          echo "âœ… index.html encontrado"
      
      # Validar manifest.json
      - name: âœ… Validar manifest.json
        run: |
          if [ ! -f "manifest.json" ]; then
            echo "âŒ ERROR: manifest.json no encontrado"
            exit 1
          fi
          # Validar que es JSON vÃ¡lido
          if ! python3 -m json.tool manifest.json > /dev/null; then
            echo "âŒ ERROR: manifest.json no es JSON vÃ¡lido"
            exit 1
          fi
          echo "âœ… manifest.json es vÃ¡lido"
      
      # Verificar archivos crÃ­ticos existen
      - name: ğŸ“‚ Verificar archivos crÃ­ticos
        run: |
          critical_files=(
            "js/app.js"
            "js/api.js"
            "js/config.js"
            "js/database.js"
            "js/referencias-sync.js"
            "js/sync.js"
            "sw.js"
            "package.json"
          )
          
          missing=0
          for file in "${critical_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ FALTA: $file"
              ((missing++))
            else
              echo "âœ… OK: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "âŒ ERROR: $missing archivo(s) crÃ­tico(s) faltante(s)"
            exit 1
          fi
          echo "âœ… Todos los archivos crÃ­ticos existen"
      
      # Validar que los scripts estÃ¡n en index.html
      - name: ğŸ”— Verificar referencias de scripts
        run: |
          scripts=(
            "js/config.js"
            "js/database.js"
            "js/api.js"
            "js/referencias-sync.js"
            "js/sync.js"
            "js/app.js"
          )
          
          for script in "${scripts[@]}"; do
            if grep -q "src=\"$script\"" index.html; then
              echo "âœ… Script referenciado: $script"
            else
              echo "âŒ FALTA referencia: $script"
              exit 1
            fi
          done
          echo "âœ… Todos los scripts estÃ¡n referenciados"
      
      # Verificar que no hay console.error no intencionales
      - name: ğŸ” Buscar console.error no intencionales
        run: |
          if grep -r "console\.error" js/ | grep -v "^\s*//" | grep -v "console\.error('"; then
            echo "âš ï¸ Advertencia: Hay console.error en el cÃ³digo"
          else
            echo "âœ… No hay console.error problemÃ¡tico"
          fi
      
      # Verificar que package.json es vÃ¡lido
      - name: âœ… Validar package.json
        run: |
          if ! python3 -m json.tool package.json > /dev/null; then
            echo "âŒ ERROR: package.json no es JSON vÃ¡lido"
            exit 1
          fi
          echo "âœ… package.json es vÃ¡lido"
      
      # Verificar Service Worker
      - name: âœ… Verificar Service Worker
        run: |
          if [ ! -f "sw.js" ]; then
            echo "âŒ ERROR: sw.js (Service Worker) no encontrado"
            exit 1
          fi
          if ! grep -q "CACHE_NAME" sw.js; then
            echo "âŒ ERROR: sw.js no tiene CACHE_NAME"
            exit 1
          fi
          echo "âœ… Service Worker es vÃ¡lido"
      
      # Verificar README y documentaciÃ³n
      - name: ğŸ“š Verificar documentaciÃ³n
        run: |
          docs=(
            "documentacion/01_README.md"
          )
          
          for doc in "${docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… DocumentaciÃ³n: $doc"
            else
              echo "âš ï¸ Falta documentaciÃ³n: $doc (opcional)"
            fi
          done
      
      # Resumen final
      - name: ğŸ“Š Resumen de validaciÃ³n
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… TODAS LAS VALIDACIONES PASARON"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Validaciones ejecutadas:"
          echo "  âœ… HTML vÃ¡lido"
          echo "  âœ… JSON vÃ¡lido (manifest, package)"
          echo "  âœ… Archivos crÃ­ticos existen"
          echo "  âœ… Scripts referenciados"
          echo "  âœ… Service Worker vÃ¡lido"
          echo ""
          echo "La app estÃ¡ lista para desplegar a producciÃ³n."
