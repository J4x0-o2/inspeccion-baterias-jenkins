# ============================================
# Version Bumping automÃ¡tico
# Se ejecuta en: cada push a master
# Incrementa versiÃ³n segÃºn conventional commits
# ============================================

name: ğŸ“¦ Actualizar VersiÃ³n

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - 'CI-CD-SETUP.md'
      - 'documentacion/**'
      - 'README.md'

jobs:
  version-bump:
    name: Incrementar versiÃ³n
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“ Obtener commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "Message: $COMMIT_MSG"
      
      - name: ğŸ”¢ Determinar tipo de versiÃ³n
        id: version_type
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.COMMIT_MSG }}"
          
          if echo "$COMMIT_MSG" | grep -qi "^feat\|^feature"; then
            VERSION_TYPE="minor"
            echo "ğŸ“ Tipo: MINOR (feat) - Nueva feature"
          elif echo "$COMMIT_MSG" | grep -qi "^fix\|^hotfix"; then
            VERSION_TYPE="patch"
            echo "ğŸ› Tipo: PATCH (fix) - Bug fix"
          elif echo "$COMMIT_MSG" | grep -qi "^refactor\|^style\|^chore\|^ci"; then
            VERSION_TYPE="patch"
            echo "ğŸ”§ Tipo: PATCH (refactor/chore)"
          elif echo "$COMMIT_MSG" | grep -qi "^BREAKING\|^breaking"; then
            VERSION_TYPE="major"
            echo "ğŸš¨ Tipo: MAJOR - Breaking change"
          else
            VERSION_TYPE="patch"
            echo "â“ Tipo: PATCH (default)"
          fi
          
          echo "VERSION_TYPE=$VERSION_TYPE" >> $GITHUB_OUTPUT
      
      - name: ğŸ“¦ Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ğŸ”„ Incrementar versiÃ³n
        id: new_version
        run: |
          # Leer versiÃ³n actual
          CURRENT_VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "VersiÃ³n actual: $CURRENT_VERSION"
          
          # Separar en componentes
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          # Incrementar segÃºn tipo
          if [ "${{ steps.version_type.outputs.VERSION_TYPE }}" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            LABEL="MAJOR"
          elif [ "${{ steps.version_type.outputs.VERSION_TYPE }}" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
            LABEL="MINOR"
          else
            PATCH=$((PATCH + 1))
            LABEL="PATCH"
          fi
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "VersiÃ³n nueva: $NEW_VERSION [$LABEL]"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_LABEL=$LABEL" >> $GITHUB_OUTPUT
      
      - name: âœï¸ Actualizar package.json
        run: |
          sed -i 's/"version": "[^"]*"/"version": "${{ steps.new_version.outputs.NEW_VERSION }}"/' package.json
          echo "âœ… package.json actualizado"
          grep '"version"' package.json
      
      - name: ğŸ·ï¸ Crear Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add package.json
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.NEW_VERSION }}" || true
          
          git tag -a v${{ steps.new_version.outputs.NEW_VERSION }} -m "Version ${{ steps.new_version.outputs.NEW_VERSION }}" || true
      
      - name: ğŸ“¤ Push tags
        run: |
          git push origin --tags || true
          git push origin HEAD:master --force || true
      
      - name: ğŸ“¢ Crear Release en GitHub
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.new_version.outputs.NEW_VERSION }}
          release_name: v${{ steps.new_version.outputs.NEW_VERSION }} [${{ steps.version_type.outputs.VERSION_TYPE }}]
          body: |
            # ğŸ“¦ Release v${{ steps.new_version.outputs.NEW_VERSION }}
            
            **Tipo**: ${{ steps.version_type.outputs.VERSION_TYPE }} ([${{ steps.version_type.outputs.VERSION_LABEL }}])
            
            **Commit**: ${{ github.sha }}
            **Autor**: ${{ github.actor }}
            
            ## Cambios
            ```
            ${{ steps.commit.outputs.COMMIT_MSG }}
            ```
            
            ---
            Desplegado automÃ¡ticamente por GitHub Actions.
          draft: false
          prerelease: false
      
      - name: ğŸ“Š Resumen
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… VERSIÃ“N ACTUALIZADA"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ VersiÃ³n anterior: v1.2.0"
          echo "ğŸ“¦ VersiÃ³n nueva:    v${{ steps.new_version.outputs.NEW_VERSION }}"
          echo "ğŸ“ Tipo cambio:      ${{ steps.version_type.outputs.VERSION_LABEL }}"
          echo ""
          echo "ğŸ·ï¸ Tags creados y pusheados"
          echo "ğŸ“¢ Release creado en GitHub"
          echo "ğŸš€ Ready para desplegar a Vercel"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
