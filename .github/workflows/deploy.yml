# ============================================
# CD: Deployment automÃ¡tico a Vercel
# Se ejecuta en: push a master/main DESPUÃ‰S de version-bump
# ============================================

name: Deploy a Vercel

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: Desplegar a Vercel
    runs-on: ubuntu-latest
    
    steps:
      # Descargar cÃ³digo
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # Validaciones previas
      - name: âœ… Validar manifest.json
        run: python3 -m json.tool manifest.json > /dev/null
      
      - name: âœ… Validar vercel.json
        run: python3 -m json.tool vercel.json > /dev/null
      
      - name: âœ… Validar package.json
        run: python3 -m json.tool package.json > /dev/null
      
      - name: âœ… Verificar index.html existe
        run: test -f index.html
      
      # Instalar Vercel CLI
      - name: ğŸ“¦ Instalar Vercel CLI
        run: npm install -g vercel@latest
      
      # Desplegar directamente a Vercel sin autenticaciÃ³n previa
      - name: ğŸŒ Desplegar a Vercel (ProducciÃ³n)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Ejecutar deploy con token y confirmaciÃ³n automÃ¡tica
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
      
      # Verificar que el deployment fue exitoso
      - name: âœ… Verificar deployment
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT COMPLETADO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± Tu app estÃ¡ en:"
          echo "   https://inspeccion-baterias.vercel.app"
          echo ""
          echo "ğŸ“Š Rama: ${{ github.ref }}"
          echo "ğŸ”‘ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
      
      # NotificaciÃ³n de Ã©xito
      - name: ğŸ“¢ Notificar Ã©xito
        if: success()
        run: |
          echo "âœ… Deployment exitoso"
          echo "La app estÃ¡ actualizada en producciÃ³n"
