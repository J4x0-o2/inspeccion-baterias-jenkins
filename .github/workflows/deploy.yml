# ============================================
# CD: Deployment automÃ¡tico a Vercel
# Se ejecuta en: push a master/main DESPUÃ‰S de version-bump
# ============================================

name: ðŸš€ Deploy a Vercel

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: Desplegar a Vercel
    runs-on: ubuntu-latest
    
    steps:
      # Descargar cÃ³digo
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      # Instalar Vercel CLI
      - name: ðŸ“¦ Instalar Vercel CLI
        run: npm install -g vercel@latest
      
      # Pull del proyecto en Vercel (obtiene config)
      - name: ðŸ”— Conectar con Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel pull --yes --environment=production
      
      # Desplegar a producciÃ³n
      - name: ðŸŒ Desplegar a Vercel (ProducciÃ³n)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      # Verificar que el deployment fue exitoso
      - name: âœ… Verificar deployment
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT COMPLETADO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“± Tu app estÃ¡ en:"
          echo "   https://inspeccion-baterias.vercel.app"
          echo ""
          echo "ðŸ“Š Rama: ${{ github.ref }}"
          echo "ðŸ”‘ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Autor: ${{ github.actor }}"
      
      # NotificaciÃ³n de Ã©xito
      - name: ðŸ“¢ Notificar Ã©xito
        if: success()
        run: |
          echo "âœ… Deployment exitoso"
          echo "La app estÃ¡ actualizada en producciÃ³n"
  
  # Job opcional: Validaciones previas
  validate-before-deploy:
    name: Validar antes de desplegar
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: âœ… Validar manifest.json
        run: python3 -m json.tool manifest.json > /dev/null
      
      - name: âœ… Validar vercel.json
        run: python3 -m json.tool vercel.json > /dev/null
      
      - name: âœ… Validar package.json
        run: python3 -m json.tool package.json > /dev/null
      
      - name: âœ… Verificar index.html existe
        run: test -f index.html
